<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleverify - Daily Homework Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes card-enter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-animated {
            animation: card-enter 0.5s ease-out forwards;
        }

        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link.active {
            background-color: #4f46e5; color: white;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .student-card, .selection-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s, background-color 0.2s;
        }
        .student-card:hover, .selection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .selection-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
            box-shadow: 0 0 0 3px #4f46e5;
            transform: translateY(-2px) scale(1.02);
        }
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding: 0 1rem;
        }
        .history-details.open {
            max-height: 1000px; /* Arbitrary large value */
            padding: 1rem 1rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .rich-text-editor {
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            min-height: 120px;
            padding: 0.75rem;
        }
        .rich-text-editor:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.4);
        }
        .editor-toolbar button {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-swatch:hover {
            border-color: #4f46e5;
        }
        .btn-interactive {
            transition: transform 0.1s ease-in-out;
        }
        .btn-interactive:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Parent Dashboard View -->
        <div id="parent-dashboard-view" class="view active">
            <header class="bg-indigo-700 text-white p-6 rounded-xl shadow-lg mb-10">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-extrabold">Parent Dashboard</h1>
                    <button onclick="flushLocalStorage()" class="btn-interactive bg-red-500/80 hover:bg-red-500 font-semibold py-2 px-4 rounded-lg">
                        <i class="fas fa-trash-alt mr-2"></i>Flush Data
                    </button>
                </div>
            </header>
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Student Profiles</h2>
                <p class="text-slate-600 mb-8">Select a student to view their workspace, or add a new profile (max 2 for trial).</p>
                <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="add-student-form" class="mt-10 pt-6 border-t border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">Add a New Student</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="student-name-input" placeholder="Student's Name" class="p-3 border border-slate-300 rounded-lg w-full focus:ring-2 focus:ring-indigo-500">
                        <select id="student-level-select" class="p-3 border border-slate-300 rounded-lg w-full bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="P1">Primary 1</option><option value="P2">Primary 2</option><option value="P3">Primary 3</option>
                            <option value="P4">Primary 4</option><option value="P5">Primary 5</option><option value="P6">Primary 6</option>
                        </select>
                        <button id="add-student-button" onclick="addStudent()" class="btn-interactive bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Add Student</button>
                    </div>
                     <p id="student-limit-msg" class="text-sm text-slate-500 mt-4 hidden">You have reached the maximum of 2 students for this trial.</p>
                </div>
            </div>
            <div id="parent-analytics" class="mt-10 bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Daily Performance (Last 7 Days)</h2>
                <div id="parent-chart-container" class="chart-container mt-6">
                    <p class="text-center text-slate-500 h-full flex items-center justify-center">Select a student profile to see their daily progress.</p>
                </div>
            </div>
        </div>
        
        <!-- Student Workspace View -->
        <div id="student-workspace-view" class="view">
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Sidebar -->
                <aside class="w-full md:w-64 flex-shrink-0">
                    <div class="bg-slate-800 text-slate-200 p-6 rounded-xl shadow-lg h-full">
                        <h2 class="text-xl font-bold text-white mb-6">Cleverify</h2>
                        <nav class="space-y-2">
                            <a href="#" id="nav-dashboard" class="sidebar-link hover:bg-slate-700 flex items-center px-4 py-2 rounded-lg font-semibold" onclick="showStudentSubView('dashboard')"><i class="fas fa-home w-6 mr-2"></i>Dashboard</a>
                            <a href="#" id="nav-quiz" class="sidebar-link hover:bg-slate-700 flex items-center px-4 py-2 rounded-lg font-semibold" onclick="showStudentSubView('quiz-setup')"><i class="fas fa-rocket w-6 mr-2"></i>Start New Quiz</a>
                            <a href="#" id="nav-history" class="sidebar-link hover:bg-slate-700 flex items-center px-4 py-2 rounded-lg font-semibold" onclick="showStudentSubView('history')"><i class="fas fa-history w-6 mr-2"></i>My History</a>
                            <a href="#" id="nav-bank" class="sidebar-link hover:bg-slate-700 flex items-center px-4 py-2 rounded-lg font-semibold" onclick="showStudentSubView('bank')"><i class="fas fa-database w-6 mr-2"></i>Question Bank</a>
                            <a href="#" id="nav-parent" class="sidebar-link hover:bg-slate-700 flex items-center px-4 py-2 rounded-lg font-semibold mt-8" onclick="changeView('parent-dashboard-view')"><i class="fas fa-user-shield w-6 mr-2"></i>Parent View</a>
                        </nav>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-grow">
                    <header class="bg-indigo-700 text-white p-4 rounded-xl shadow-lg flex justify-between items-center mb-8">
                        <div id="student-header" class="text-xl font-bold"></div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2"><i class="fas fa-fire text-orange-400"></i><span id="student-streak">0</span></div>
                            <div class="flex items-center gap-2"><i class="fas fa-medal text-yellow-400"></i><span id="student-badges">0</span></div>
                        </div>
                    </header>
                    <div id="student-main-content">
                        <!-- Student sub-views will be rendered here -->
                    </div>
                </main>
            </div>
        </div>

    </div>
    
    <script>
        // --- Master Configuration ---
        const masterConfig = {
            P1: {
                Maths: ['Numbers to 20', 'Addition & Subtraction'],
                Science: ['Living & Non-Living Things'],
                English: []
            },
            P2: {
                Maths: ['Numbers to 100', 'Multiplication Tables'],
                Science: ['Life Cycles'],
                English: []
            },
            P3: {
                Maths: ['Fractions', 'Mass', 'Angles'],
                Science: ['Plant Systems', 'Magnets', 'Classification of Living Things - Plant & Fungi', 'Diversity of Materials'],
                English: ['Vocabulary MCQ', 'Grammar MCQ', 'Grammar Cloze', 'Comprehension Visual Text', 'Comprehension Open Ended']
            },
            P4: {
                Maths: ['Decimals', 'Area & Perimeter'],
                Science: ['Energy', 'Matter'],
                English: []
            },
            P5: {
                Maths: ['Percentage', 'Volume of Cubes'],
                Science: ['Human Body Systems', 'Water Cycle'],
                English: []
            },
            P6: {
                Maths: ['Algebra', 'Speed'],
                Science: ['Forces', 'Interactions in Ecosystems'],
                English: []
            },
        };
        const englishTemplates = {
            'Vocabulary MCQ': `My grandmother always tells me a ______ before I go to bed.\n\n1) poem 2) story 3) map 4) game\n(    )`,
            'Grammar MCQ': `She ______ going to the library tomorrow.\n\n1) is 2) are 3) was 4) were\n(    )`,
            'Grammar Cloze': `She ______ to the park every Saturday.\n\n1) go 2) goes 3) going 4) gone\n(    )`,
            'Comprehension Visual Text': `Use a single 'image' field with a URL that applies to all five questions. Display the image above the question text and options for each question.`,
            'Comprehension Open Ended': `Use a single 'image' field with a URL that applies to all five questions. Display the image above each open-ended question about the image.`
        };
        const stickers = ['⭐', '👍', '🎉', '🏆', '💯', '✨', '🤩', '🚀'];

        // --- App State ---
        let currentStudent = null;
        let studentCache = {};
        let questions = [];
        let score = 0;
        let dailyPerformanceChart = null;
        let questionBankData = [];
        
        // --- View Controller ---
        function changeView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderParentDashboard();
        });

        // --- Data Persistence (localStorage) ---
        function getStudents() {
            return JSON.parse(localStorage.getItem('cleverifyAppStudents')) || [];
        }

        function saveStudents(students) {
            localStorage.setItem('cleverifyAppStudents', JSON.stringify(students));
        }

        function getHistory(studentId) {
            const allHistory = JSON.parse(localStorage.getItem('cleverifyAppHistory')) || {};
            return allHistory[studentId] || [];
        }
        
        function flushLocalStorage() {
            if (confirm("Are you sure you want to delete all student data? This cannot be undone.")) {
                localStorage.removeItem('cleverifyAppStudents');
                localStorage.removeItem('cleverifyAppHistory');
                renderParentDashboard();
            }
        }

        function saveTestResult(evaluation, userAnswers) {
            const allHistory = JSON.parse(localStorage.getItem('cleverifyAppHistory')) || {};
            if (!allHistory[currentStudent.id]) {
                allHistory[currentStudent.id] = [];
            }
            
            const quizResult = {
                date: new Date().toISOString(),
                subject: window.currentQuizParams.subject,
                topic: window.currentQuizParams.topic,
                score: score,
                total: questions.length,
                results: questions.map((q, i) => ({
                    question: q.question,
                    userAnswer: userAnswers[i],
                    correctAnswer: evaluation[i].correct_answer,
                    explanation: evaluation[i].explanation,
                    isCorrect: evaluation[i].is_correct
                }))
            };

            allHistory[currentStudent.id].unshift(quizResult);
            localStorage.setItem('cleverifyAppHistory', JSON.stringify(allHistory));
            handleCompletion(quizResult);
        }

        // --- Parent & Student Profile Management ---
        function renderParentDashboard() {
            const students = getStudents();
            const studentListEl = document.getElementById('student-list');
            const addStudentForm = document.getElementById('add-student-form');
            const studentLimitMsg = document.getElementById('student-limit-msg');
            
            studentListEl.innerHTML = '';
            if (students.length === 0) {
                studentListEl.innerHTML = '<p class="text-slate-500 col-span-full text-center">No student profiles found. Please add one below.</p>';
            } else {
                students.forEach((student, index) => {
                    const card = document.createElement('div');
                    card.className = 'student-card bg-slate-100 p-6 rounded-lg cursor-pointer flex flex-col items-center text-center card-animated';
                    card.style.animationDelay = `${index * 100}ms`;
                    card.innerHTML = `<div class="w-16 h-16 rounded-full bg-blue-200 flex items-center justify-center text-2xl font-bold text-blue-700 mb-3">${student.name.charAt(0)}</div><h3 class="text-xl font-bold text-slate-800">${student.name}</h3><p class="text-slate-500">${student.level}</p>`;
                    card.onclick = () => selectStudent(student);
                    studentListEl.appendChild(card);
                });
            }

            if (students.length >= 2) {
                addStudentForm.classList.add('hidden');
                studentLimitMsg.classList.remove('hidden');
            } else {
                addStudentForm.classList.remove('hidden');
                studentLimitMsg.classList.add('hidden');
            }

            renderDailyPerformanceChart(null);
            changeView('parent-dashboard-view');
        }

        function addStudent() {
            const nameInput = document.getElementById('student-name-input');
            const levelSelect = document.getElementById('student-level-select');
            const studentName = nameInput.value.trim();
            if (studentName) {
                const students = getStudents();
                if (students.length < 2) {
                    students.push({
                        id: `student${Date.now()}`,
                        name: studentName,
                        level: levelSelect.value,
                        gamification: { streak: 0, lastCompletedDate: null, badges: [] }
                    });
                    saveStudents(students);
                    nameInput.value = '';
                    renderParentDashboard();
                }
            }
        }

        function selectStudent(student) {
            currentStudent = student;
            loadStudentData(student.id);
            renderStudentWorkspace();
            renderDailyPerformanceChart(student.id);
            changeView('student-workspace-view');
        }

        // --- Data Caching & Processing ---
        function loadStudentData(studentId) {
            const students = getStudents();
            const profile = students.find(s => s.id === studentId);
            const history = getHistory(studentId);
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const recentHistory = history.filter(h => new Date(h.date) >= oneWeekAgo);

            const weeklyStats = { Maths: { correct: 0, total: 0 }, Science: { correct: 0, total: 0 }, English: { correct: 0, total: 0 } };
            recentHistory.forEach(quiz => {
                if (weeklyStats[quiz.subject]) {
                    weeklyStats[quiz.subject].correct += quiz.score;
                    weeklyStats[quiz.subject].total += quiz.total;
                }
            });

            studentCache = { profile, fullHistory: history, weeklyStats };
        }

        // --- Student Workspace Rendering ---
        function renderStudentWorkspace() {
            document.getElementById('student-header').innerHTML = `<span>${studentCache.profile.name}</span><span class="ml-2 text-sm font-medium bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md">${studentCache.profile.level}</span>`;
            updateGamificationDisplay();
            showStudentSubView('dashboard');
        }

        function showStudentSubView(subView) {
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById(`nav-${subView.split('-')[0]}`).classList.add('active');
            
            const contentArea = document.getElementById('student-main-content');
            if (subView === 'dashboard') {
                renderStudentDashboard(contentArea);
            } else if (subView === 'quiz-setup') {
                renderQuizSetup(contentArea);
            } else if (subView === 'history') {
                renderHistoryView(contentArea);
            } else if (subView === 'bank') {
                renderQuestionBankView(contentArea);
            } else if (subView === 'quiz') {
                renderQuizInterface(contentArea, window.currentQuizParams);
            }
        }

        function renderStudentDashboard(container) {
            loadStudentData(currentStudent.id);
            const stats = studentCache.weeklyStats;
            const mathsAccuracy = stats.Maths.total > 0 ? (stats.Maths.correct / stats.Maths.total * 100).toFixed(0) : 0;
            const scienceAccuracy = stats.Science.total > 0 ? (stats.Science.correct / stats.Science.total * 100).toFixed(0) : 0;
            const englishAccuracy = stats.English.total > 0 ? (stats.English.correct / stats.English.total * 100).toFixed(0) : 0;
            
            container.innerHTML = `
                <div class="space-y-10">
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-100 p-8 rounded-xl shadow-lg text-center border border-slate-200 card-animated">
                        <h2 class="text-3xl font-bold text-slate-900">Ready for your Daily Dose?</h2>
                        <p class="text-slate-600 mt-2">Let's practice some ${masterConfig[currentStudent.level].Maths[0]} questions.</p>
                        <button class="btn-interactive mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg text-xl" onclick="showStudentSubView('quiz-setup')">Start Now</button>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 mb-4">This Week's Performance</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 card-animated" style="animation-delay: 100ms;">
                                <h3 class="font-bold text-lg text-blue-600">Maths</h3>
                                <p class="text-4xl font-extrabold text-slate-900 mt-2">${mathsAccuracy}%</p>
                                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
                                    <div class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: ${mathsAccuracy}%"></div>
                                </div>
                                <p class="text-sm text-slate-500 mt-2">${stats.Maths.total} questions answered</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 card-animated" style="animation-delay: 200ms;">
                                <h3 class="font-bold text-lg text-green-600">Science</h3>
                                <p class="text-4xl font-extrabold text-slate-900 mt-2">${scienceAccuracy}%</p>
                                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
                                    <div class="bg-green-500 h-2.5 rounded-full progress-bar-fill" style="width: ${scienceAccuracy}%"></div>
                                </div>
                                <p class="text-sm text-slate-500 mt-2">${stats.Science.total} questions answered</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 card-animated" style="animation-delay: 300ms;">
                                <h3 class="font-bold text-lg text-yellow-600">English</h3>
                                <p class="text-4xl font-extrabold text-slate-900 mt-2">${englishAccuracy}%</p>
                                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-3">
                                    <div class="bg-yellow-500 h-2.5 rounded-full progress-bar-fill" style="width: ${englishAccuracy}%"></div>
                                </div>
                                <p class="text-sm text-slate-500 mt-2">${stats.English.total} questions answered</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuizSetup(container) {
            container.innerHTML = `<div id="quiz-setup-container" class="space-y-8"></div>`;
            renderSubjectSelection();
        }

        function renderSubjectSelection() {
            const container = document.getElementById('quiz-setup-container');
            const subjects = Object.keys(masterConfig[currentStudent.level]);
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 card-animated">
                    <h2 class="text-2xl font-bold text-slate-900">Step 1: Choose a Subject</h2>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        ${subjects.map(s => `<button class="selection-card p-6 bg-slate-50 rounded-lg border-2 border-transparent text-center relative" onclick="selectSubject(this, '${s}')">${s}<span class="check-icon hidden absolute top-2 right-2 text-indigo-600"><i class="fas fa-check-circle"></i></span></button>`).join('')}
                    </div>
                </div>
            `;
        }

        function selectSubject(element, subject) {
            element.querySelector('.check-icon').classList.remove('hidden');
            document.querySelectorAll('#quiz-setup-container .selection-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            setTimeout(() => {
                window.currentQuizParams = { subject };
                renderTopicSelection();
            }, 300);
        }

        function renderTopicSelection() {
            const container = document.getElementById('quiz-setup-container');
            const topics = masterConfig[currentStudent.level][window.currentQuizParams.subject];
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 card-animated">
                    <h2 class="text-2xl font-bold text-slate-900">Step 2: Choose a Topic for ${window.currentQuizParams.subject}</h2>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                         ${topics.map(t => `<button class="selection-card p-6 bg-slate-50 rounded-lg border-2 border-transparent text-center relative" onclick="selectTopic(this, '${t}')">${t}<span class="check-icon hidden absolute top-2 right-2 text-indigo-600"><i class="fas fa-check-circle"></i></span></button>`).join('')}
                    </div>
                    <button onclick="renderSubjectSelection()" class="mt-6 text-sm text-slate-500 hover:underline">&larr; Back to Subjects</button>
                </div>
            `;
        }

        function selectTopic(element, topic) {
            element.querySelector('.check-icon').classList.remove('hidden');
            document.querySelectorAll('#quiz-setup-container .selection-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            setTimeout(() => {
                window.currentQuizParams.topic = topic;
                renderDifficultySelection();
            }, 300);
        }

        function renderDifficultySelection() {
            const container = document.getElementById('quiz-setup-container');
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 card-animated">
                    <h2 class="text-2xl font-bold text-slate-900">Step 3: Choose Difficulty for ${window.currentQuizParams.topic}</h2>
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <button class="selection-card p-6 bg-slate-50 rounded-lg border-2 border-transparent text-center relative" onclick="selectDifficulty(this, 'Easy')">Easy<span class="check-icon hidden absolute top-2 right-2 text-indigo-600"><i class="fas fa-check-circle"></i></span></button>
                        <button class="selection-card p-6 bg-slate-50 rounded-lg border-2 border-transparent text-center relative" onclick="selectDifficulty(this, 'Medium')">Medium<span class="check-icon hidden absolute top-2 right-2 text-indigo-600"><i class="fas fa-check-circle"></i></span></button>
                        <button class="selection-card p-6 bg-slate-50 rounded-lg border-2 border-transparent text-center relative" onclick="selectDifficulty(this, 'Hard')">Hard<span class="check-icon hidden absolute top-2 right-2 text-indigo-600"><i class="fas fa-check-circle"></i></span></button>
                    </div>
                    <button onclick="renderTopicSelection()" class="mt-6 text-sm text-slate-500 hover:underline">&larr; Back to Topics</button>
                </div>
            `;
        }
        
        function selectDifficulty(element, difficulty) {
            element.querySelector('.check-icon').classList.remove('hidden');
            document.querySelectorAll('#quiz-setup-container .selection-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            setTimeout(() => {
                window.currentQuizParams.difficulty = difficulty;
                window.currentQuizParams.classLevel = currentStudent.level;
                showStudentSubView('quiz');
            }, 300);
        }

        function renderQuizInterface(container, params) {
            container.innerHTML = `
                <div id="loader-container" class="flex justify-center items-center h-64">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-slate-200 h-32 w-32"></div>
                    <p id="loader-text" class="ml-4 text-lg font-semibold text-slate-600">Generating questions...</p>
                </div>
                <div id="questions-container" class="hidden space-y-6"></div>
                <div id="evaluation-container" class="hidden space-y-6"></div>
                <div id="quiz-actions" class="mt-8">
                    <button id="submit-button" class="hidden btn-interactive w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg" onclick="evaluateAnswers()">Check My Answers!</button>
                    <button id="restart-button" class="hidden btn-interactive w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" onclick="showStudentSubView('quiz-setup')">Take Another Quiz</button>
                </div>
            `;
            fetchQuestions(params);
        }

        async function fetchQuestions(params) {
            document.getElementById('loader-container').classList.remove('hidden');
            try {
                const history = getHistory(currentStudent.id);
                const previousQuestions = history
                    .filter(test => test.topic === params.topic)
                    .flatMap(test => test.results.map(r => r.question));
                
                params.previous_questions = [...new Set(previousQuestions)];

                if (params.subject === 'English') {
                    params.template = englishTemplates[params.topic] || '';
                }
                const response = await callBackendAPI('/api/generate', params);
                questions = response.questions;
                displayQuestions();
            } catch (error) {
                console.error("Error fetching questions:", error);
                document.getElementById('loader-container').innerHTML = `<p class="text-red-500 text-center">Sorry, something went wrong fetching questions. Please try again.</p>`;
            }
        }
        
        // Other functions (displayQuestions, evaluateAnswers, etc.) are restored below...

        function displayQuestions() {
            document.getElementById('loader-container').classList.add('hidden');
            const container = document.getElementById('questions-container');
            container.classList.remove('hidden');
            container.innerHTML = '';
            questions.forEach((q, index) => {
                const qElement = document.createElement('div');
                qElement.className = 'p-6 bg-white rounded-lg border border-slate-200';
                let answerHtml = '';
                switch (q.type) {
                    case 'single-choice':
                        answerHtml = `<div class="space-y-3 mt-4">${q.options.map((opt, i) => `
                            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
                                <input type="radio" name="q${index}" value="${opt}" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                <span class="ml-3 text-slate-700">${opt}</span>
                            </label>`).join('')}</div>`;
                        break;
                    case 'multi-select':
                        answerHtml = `<div class="space-y-3 mt-4">${q.options.map((opt, i) => `
                            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" name="q${index}" value="${opt}" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                <span class="ml-3 text-slate-700">${opt}</span>
                            </label>`).join('')}</div>`;
                        break;
                    case 'free-text':
                        answerHtml = `
                            <div class="editor-toolbar mt-4 flex items-center space-x-2 p-2 bg-slate-100 rounded-t-lg border-b-0 border border-slate-300">
                                <button onclick="formatDoc('bold', ${index})" class="font-bold hover:bg-slate-200 rounded">B</button>
                                <div class="w-px h-5 bg-slate-300"></div>
                                <div class="flex items-center space-x-1">
                                    <div class="color-swatch bg-black" onclick="formatDoc('foreColor', ${index}, '#000000')"></div>
                                    <div class="color-swatch" style="background-color: #EF4444" onclick="formatDoc('foreColor', ${index}, '#EF4444')"></div>
                                    <div class="color-swatch" style="background-color: #3B82F6" onclick="formatDoc('foreColor', ${index}, '#3B82F6')"></div>
                                    <div class="color-swatch" style="background-color: #10B981" onclick="formatDoc('foreColor', ${index}, '#10B981')"></div>
                                </div>
                            </div>
                            <div id="answer-${index}" class="rich-text-editor bg-white" contenteditable="true"></div>`;
                        break;
                }
                let headerHtml = `
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-lg text-slate-800 mb-2 flex-grow">${index + 1}. ${q.question}</p>
                        <button id="hint-btn-${index}" onclick="getHint(${index})" class="hint-button text-white font-bold py-1 px-3 rounded-lg text-sm ml-4 flex-shrink-0">
                            <i class="fas fa-lightbulb"></i> Hint
                        </button>
                    </div>`;
                if (q.image) {
                    headerHtml = `<div class="mb-4 text-center"><img src="${q.image}" alt="Question Image" class="max-w-full h-auto mx-auto rounded"/></div>` + headerHtml;
                }
                qElement.innerHTML = `
                    ${headerHtml}
                    ${answerHtml}
                    <div id="hint-text-${index}" class="hidden mt-2 p-2 hint-text rounded"></div>
                `;
                container.appendChild(qElement);
            });
            document.getElementById('submit-button').classList.remove('hidden');
        }

        function formatDoc(command, index, value = null) {
            document.execCommand(command, false, value);
            document.getElementById(`answer-${index}`).focus();
        }
        
        async function getHint(index) {
            const hintBtn = document.getElementById(`hint-btn-${index}`);
            const hintTextEl = document.getElementById(`hint-text-${index}`);
            hintBtn.disabled = true;
            hintBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const questionText = questions[index].question;
            
            try {
                const response = await callBackendAPI('/api/get-hint', { question: questionText });
                hintTextEl.textContent = `Hint: ${response.text}`;
                hintTextEl.classList.remove('hidden');
                hintBtn.classList.add('hidden');
            } catch (error) {
                console.error("Error fetching hint:", error);
                hintTextEl.textContent = "Sorry, couldn't get a hint right now.";
                hintTextEl.classList.remove('hidden');
                hintBtn.disabled = false;
                hintBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Hint';
            }
        }

        async function evaluateAnswers() {
            const loaderContainer = document.getElementById('loader-container');
            loaderContainer.classList.remove('hidden');
            loaderContainer.querySelector('#loader-text').textContent = 'Evaluating answers...';
            document.getElementById('questions-container').classList.add('hidden');
            document.getElementById('submit-button').classList.add('hidden');
            
            const userAnswers = questions.map((q, i) => {
                switch (q.type) {
                    case 'single-choice':
                        const checkedRadio = document.querySelector(`input[name="q${i}"]:checked`);
                        return checkedRadio ? checkedRadio.value : "";
                    case 'multi-select':
                        const checkedBoxes = document.querySelectorAll(`input[name="q${i}"]:checked`);
                        return Array.from(checkedBoxes).map(cb => cb.value);
                    case 'free-text':
                        return document.getElementById(`answer-${i}`).innerHTML;
                    default:
                        return "";
                }
            });
            
            try {
                const response = await callBackendAPI('/api/evaluate', { questions, answers: userAnswers });
                score = response.evaluation.filter(e => e.is_correct).length;
                saveTestResult(response.evaluation, userAnswers);
                displayEvaluation(response.evaluation, userAnswers);
            } catch (error) {
                console.error("Error evaluating answers:", error);
                loaderContainer.innerHTML = `<p class="text-red-500 text-center">Sorry, something went wrong during evaluation. Please try again.</p>`;
            }
        }

        function displayEvaluation(evaluation, userAnswers) {
            document.getElementById('loader-container').classList.add('hidden');
            const container = document.getElementById('evaluation-container');
            container.classList.remove('hidden');
            
            let stickersHtml = '';
            for(let i = 0; i < score; i++) {
                stickersHtml += `<span class="text-4xl">${stickers[i % stickers.length]}</span>`;
            }

            container.innerHTML = `
                <div class="text-center bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-3xl font-bold mb-4">Quiz Complete!</h3>
                    <p class="text-xl text-slate-600">You scored ${score} out of ${questions.length}.</p>
                    <div class="mt-4 flex justify-center gap-2">${stickersHtml || '<p class="text-slate-500">No stickers earned this time. Keep trying!</p>'}</div>
                </div>
            `;
            
            evaluation.forEach((result, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = `p-4 rounded-lg border ${result.is_correct ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}`;
                let userAnswerHtml = '';
                if (questions[index].type === 'free-text') {
                    userAnswerHtml = userAnswers[index];
                } else if (Array.isArray(userAnswers[index])) {
                    userAnswerHtml = userAnswers[index].join(', ') || "No answer given";
                } else {
                    userAnswerHtml = userAnswers[index] || "No answer given";
                }

                resultElement.innerHTML = `
                    <p class="font-semibold text-lg">${index + 1}. ${questions[index].question}</p>
                    <div class="mt-2 p-2 border-l-4 border-slate-200">Your answer: <span class="font-medium">${userAnswerHtml}</span></div>
                    <div class="mt-2 p-3 rounded-md ${result.is_correct ? 'bg-green-100' : 'bg-red-100'}">
                        <p class="font-bold ${result.is_correct ? 'text-green-700' : 'text-red-700'}">
                            ${result.is_correct ? `<i class="fas fa-check-circle mr-2"></i>Correct! <span class="text-2xl ml-2">${stickers[index % stickers.length]}</span>` : '<i class="fas fa-times-circle mr-2"></i>Not quite!'}
                        </p>
                        <p class="mt-1">Correct Answer: <span class="font-semibold">${result.correct_answer}</span></p>
                        <p class="mt-1 text-slate-700"><em>${result.explanation}</em></p>
                    </div>`;
                container.appendChild(resultElement);
            });
            document.getElementById('restart-button').classList.remove('hidden');
        }

        function renderHistoryView(container) {
            const history = studentCache.fullHistory;
            if (history.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-lg bg-white p-8 rounded-lg shadow-md">No homework has been completed yet.</p>';
                return;
            }
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Quiz History</h2>
                <div class="space-y-4">
                ${history.map((test, index) => `
                    <div class="bg-white rounded-lg shadow-md">
                        <button class="w-full text-left p-4" onclick="toggleHistoryDetails('history-details-${index}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg">${test.subject}: ${test.topic}</h3>
                                    <p class="text-sm text-slate-500">${new Date(test.date).toLocaleDateString()}</p>
                                </div>
                                <p class="text-xl font-bold">${test.score}/${test.total}</p>
                            </div>
                        </button>
                        <div id="history-details-${index}" class="history-details space-y-4 border-t border-slate-200">
                            ${test.results.map((r, i) => `
                                <div class="p-3 rounded-md ${r.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                                    <p class="font-semibold">${i + 1}. ${r.question}</p>
                                    <p class="text-sm mt-1">Your answer: ${r.userAnswer}</p>
                                    <p class="text-sm mt-1">Correct answer: ${r.correctAnswer}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                </div>
            `;
        }
        
        function renderQuestionBankView(container) {
            const allHistory = getHistory(currentStudent.id);
            const questionMap = new Map();
            allHistory.forEach(test => {
                test.results.forEach(result => {
                    if (!questionMap.has(result.question)) {
                        questionMap.set(result.question, {
                            topic: test.topic,
                            correctAnswer: result.correctAnswer,
                            explanation: result.explanation
                        });
                    }
                });
            });

            const uniqueQuestions = Array.from(questionMap.entries());

            if (uniqueQuestions.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500 text-lg bg-white p-8 rounded-lg shadow-md">No questions in the bank yet. Complete a quiz to add questions.</p>';
                return;
            }
            questionBankData = uniqueQuestions;

            container.innerHTML = `
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Question Bank</h2>
                    <button id="download-question-bank" onclick="downloadQuestionBank()" aria-label="Download question bank" class="btn-interactive bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"><i class="fas fa-download mr-2"></i>Download</button>
                 </div>
                 <div class="space-y-4">
                    ${uniqueQuestions.map(([question, data], index) => `
                        <div class="bg-white rounded-lg shadow-md">
                            <button class="w-full text-left p-4" onclick="toggleHistoryDetails('bank-details-${index}')">
                                <p class="font-semibold">${index + 1}. ${question}</p>
                                <p class="text-sm text-slate-500 mt-1">Topic: ${data.topic}</p>
                            </button>
                            <div id="bank-details-${index}" class="history-details border-t border-slate-200">
                                <div class="p-3 rounded-md bg-blue-50">
                                    <p><strong>Answer:</strong> ${data.correctAnswer}</p>
                                    <p class="text-sm mt-1"><em>${data.explanation}</em></p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                 </div>
            `;
        }

        function downloadQuestionBank() {
            if (!questionBankData.length) return;
            const formatted = questionBankData.map(([question, data]) => ({
                question,
                topic: data.topic,
                correctAnswer: data.correctAnswer,
                explanation: data.explanation
            }));
            const blob = new Blob([JSON.stringify(formatted, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `question-bank-${currentStudent?.id || 'data'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleHistoryDetails(elementId) {
            document.getElementById(elementId).classList.toggle('open');
        }
        
        // --- Gamification ---
        function handleCompletion(quizResult) {
            const students = getStudents();
            const student = students.find(s => s.id === currentStudent.id);
            if (!student) return;

            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0];

            if (student.gamification.lastCompletedDate === yesterday) {
                student.gamification.streak++;
            } else if (student.gamification.lastCompletedDate !== today) {
                student.gamification.streak = 1;
            }
            student.gamification.lastCompletedDate = today;

            if (student.gamification.streak >= 3 && !student.gamification.badges.includes('3-Day Streak')) {
                student.gamification.badges.push('3-Day Streak');
            }
            if (quizResult.score === quizResult.total && !student.gamification.badges.includes('Perfect Score!')) {
                student.gamification.badges.push('Perfect Score!');
            }
            const history = getHistory(student.id);
            if (history.length >= 10 && !student.gamification.badges.includes('Homework Hero')) {
                student.gamification.badges.push('Homework Hero');
            }
            
            saveStudents(students);
            loadStudentData(student.id);
            updateGamificationDisplay();
        }

        function updateGamificationDisplay() {
            const gamification = studentCache.profile?.gamification;
            if (gamification) {
                document.getElementById('student-streak').innerText = gamification.streak || 0;
                document.getElementById('student-badges').innerText = gamification.badges?.length || 0;
            }
        }
        
        // --- Parent Dashboard Chart ---
        function renderDailyPerformanceChart(studentId) {
            const container = document.getElementById('parent-chart-container');
            if (dailyPerformanceChart) {
                dailyPerformanceChart.destroy();
            }
            if (!studentId) {
                container.innerHTML = '<p class="text-center text-slate-500 h-full flex items-center justify-center">Select a student to view their daily performance.</p>';
                return;
            }
            container.innerHTML = '<canvas id="daily-performance-chart"></canvas>';
            const ctx = document.getElementById('daily-performance-chart').getContext('2d');

            const history = getHistory(studentId);
            const labels = [];
            const dataByDay = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayString = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                dataByDay[dayString] = { Maths: { scores: [], count: 0 }, Science: { scores: [], count: 0 }, English: { scores: [], count: 0 } };
            }

            history.forEach(test => {
                const dayString = new Date(test.date).toISOString().split('T')[0];
                if (dataByDay[dayString] && dataByDay[dayString][test.subject]) {
                    dataByDay[dayString][test.subject].scores.push((test.score / test.total) * 100);
                    dataByDay[dayString][test.subject].count++;
                }
            });

            const mathsData = labels.map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                const dayString = d.toISOString().split('T')[0];
                const dayData = dataByDay[dayString].Maths;
                return dayData.count > 0 ? dayData.scores.reduce((a, b) => a + b, 0) / dayData.count : 0;
            });

            const scienceData = labels.map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                const dayString = d.toISOString().split('T')[0];
                const dayData = dataByDay[dayString].Science;
                return dayData.count > 0 ? dayData.scores.reduce((a, b) => a + b, 0) / dayData.count : 0;
            });

            const englishData = labels.map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                const dayString = d.toISOString().split('T')[0];
                const dayData = dataByDay[dayString].English;
                return dayData.count > 0 ? dayData.scores.reduce((a, b) => a + b, 0) / dayData.count : 0;
            });

            dailyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Maths Avg Score', data: mathsData, backgroundColor: '#3B82F6' },
                        { label: 'Science Avg Score', data: scienceData, backgroundColor: '#10B981' },
                        { label: 'English Avg Score', data: englishData, backgroundColor: '#F59E0B' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Average Score (%)' } } }
                }
            });
        }

        // --- API Communication ---
        async function callBackendAPI(endpoint, data) {
            const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5001' 
                : 'https://homework-app-psi.vercel.app';
            
            const backendUrl = baseUrl + endpoint;
            
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error from backend:", errorData);
                    throw new Error(`API call failed: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Network or fetch error:", error);
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    console.error("This might be a CORS issue or the backend server is not running. Ensure your Python server is active at " + baseUrl);
                }
                throw error;
            }
        }

    </script>
</body>
</html>
